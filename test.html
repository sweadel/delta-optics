<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Delta Optics | نظام الفحص الذكي</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #00796B; --gold: #D4AF37; --bg: #f4f7f6; --text: #37474F; }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; display: flex; flex-direction: column; }
        
        /* الهيدر */
        header { background: #fff; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; }
        .logo-text { font-weight: 800; color: var(--primary); font-size: 1.1rem; display: flex; align-items: center; gap: 5px; }
        .back-btn { color: #555; font-size: 1.2rem; cursor: pointer; }

        /* الحاوية */
        .test-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .screen { display: none; width: 100%; max-width: 450px; background: white; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; animation: fadeIn 0.4s ease-out; }
        .screen.active { display: block; }

        /* الأزرار */
        .btn-main { background: linear-gradient(135deg, var(--primary), #004D40); color: white; padding: 15px 30px; border-radius: 50px; border: none; font-weight: 800; cursor: pointer; width: 100%; margin-top: 15px; font-size: 1rem; box-shadow: 0 5px 15px rgba(0,121,107,0.3); transition: 0.3s; }
        .btn-main:active { transform: scale(0.98); }
        .btn-sec { background: #fff; color: var(--text); border: 2px solid #eee; padding: 12px; border-radius: 50px; width: 100%; margin-top: 10px; font-weight: bold; cursor: pointer; }

        /* فحص النظر E */
        .e-box { font-size: 100px; font-weight: 900; margin: 30px auto; transition: transform 0.3s; line-height: 1; width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; border: 2px solid #f0f0f0; border-radius: 20px; }
        .ctrl-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 250px; margin: 0 auto; }
        .ctrl-btn { width: 65px; height: 65px; background: #fff; border: 1px solid #eee; border-radius: 18px; font-size: 1.5rem; color: var(--primary); cursor: pointer; box-shadow: 0 4px 0 #eee; transition: 0.1s; }
        .ctrl-btn:active { transform: translateY(4px); box-shadow: none; }

        /* فحص الألوان */
        .color-img-box { width: 220px; height: 220px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; background: #fafafa; border-radius: 50%; overflow: hidden; border: 4px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .color-test-img { width: 100%; height: 100%; object-fit: cover; }
        .color-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .opt-btn { padding: 15px; border: 1px solid #eee; border-radius: 12px; background: #fff; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
        .opt-btn:active { background: var(--primary); color: white; }

        /* السجل */
        .history-list { text-align: right; margin-top: 25px; max-height: 150px; overflow-y: auto; background: #f9f9f9; padding: 15px; border-radius: 15px; }
        .history-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.85rem; }

        /* شريط التقدم */
        .prog-track { width: 100%; height: 8px; background: #eee; border-radius: 10px; margin-bottom: 20px; overflow: hidden; }
        .prog-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.3s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="back-btn"><i class="fas fa-times"></i></a>
    <span class="logo-text"><i class="fas fa-glasses"></i> مركز الفحص</span>
    <div id="muteBtn" onclick="toggleMute()" style="cursor:pointer; color:var(--primary); width:30px;"><i class="fas fa-volume-up"></i></div>
</header>

<div class="test-container">

    <div id="screen-start" class="screen active">
        <i class="fas fa-user-md" style="font-size: 3.5rem; color: var(--primary); margin-bottom: 15px;"></i>
        <h2 style="margin: 0 0 10px;">أهلاً بك يا هندسة</h2>
        <p style="color:#666; font-size:0.9rem; margin-bottom:25px;">اختر نوع الفحص لبدء التشخيص</p>
        
        <button class="btn-main" onclick="startVisionTest()">
            <i class="fas fa-eye"></i> فحص حدة النظر
        </button>
        <button class="btn-sec" onclick="startColorTest()">
            <i class="fas fa-palette"></i> فحص عمى الألوان
        </button>
        
        <div class="history-list" id="history-container">
            <div style="font-weight:bold; font-size:0.8rem; margin-bottom:10px; color:var(--gold);">السجل السابق:</div>
            <div id="history-items"></div>
        </div>
    </div>

    <div id="screen-vision" class="screen">
        <div class="prog-track"><div id="vision-prog" class="prog-fill"></div></div>
        <div id="e-char" class="e-box">E</div>
        <p style="color:#999; font-size:0.9rem; margin-bottom: 20px;">حدد اتجاه الفتحة</p>
        <div class="ctrl-grid">
            <button class="ctrl-btn" style="grid-column: 2" onclick="processVision(270)"><i class="fas fa-chevron-up"></i></button>
            <button class="ctrl-btn" style="grid-column: 1; grid-row: 2" onclick="processVision(180)"><i class="fas fa-chevron-left"></i></button>
            <button class="ctrl-btn" style="grid-column: 2; grid-row: 2" onclick="processVision(90)"><i class="fas fa-chevron-down"></i></button>
            <button class="ctrl-btn" style="grid-column: 3; grid-row: 2" onclick="processVision(0)"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <div id="screen-color" class="screen">
        <div class="prog-track"><div id="color-prog" class="prog-fill"></div></div>
        <h3 style="margin: 0 0 20px;">ما الرقم الموجود؟</h3>
        
        <div class="color-img-box">
            <img id="color-img" src="" class="color-test-img">
        </div>

        <div class="color-options" id="color-opts"></div>
    </div>

    <div id="screen-result" class="screen">
        <div style="width:90px; height:90px; background:#e8f5e9; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 15px; color:#4CAF50; font-size:2.5rem;">
            <i class="fas fa-check-circle"></i>
        </div>
        <h3 id="result-title">النتيجة</h3>
        <div style="font-size: 2.2rem; font-weight: 800; color: var(--primary); margin: 10px 0;" id="result-val">---</div>
        <p style="color:#666; font-size:0.9rem;">تم حفظ النتيجة في سجلك.</p>
        
        <a id="wa-link" href="#" class="btn-main" style="display:block; text-decoration:none; color:white;">
            <i class="fab fa-whatsapp"></i> إرسال للدكتور
        </a>
        <button class="btn-sec" onclick="location.reload()">العودة للرئيسية</button>
    </div>

</div>

<script>
    // --- 1. نظام الصوت (ناعم جداً) ---
    let isMuted = false;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playTone(freq) {
        if (isMuted) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.type = 'sine'; // موجة ناعمة
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

        // تلاشي ناعم للصوت
        gain.gain.setValueAtTime(0, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 0.05);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);

        osc.connect(gain);
        gain.connect(audioCtx.destination);

        osc.start();
        osc.stop(audioCtx.currentTime + 0.3);
    }

    // --- 2. السجل ---
    function saveResult(type, score) {
        let history = JSON.parse(localStorage.getItem('delta_history') || '[]');
        history.unshift({ type, score, date: new Date().toLocaleDateString('ar-EG') });
        localStorage.setItem('delta_history', JSON.stringify(history.slice(0, 5)));
        loadHistory();
    }

    function loadHistory() {
        const container = document.getElementById('history-items');
        let history = JSON.parse(localStorage.getItem('delta_history') || '[]');
        if(history.length === 0) { container.innerHTML = "<p style='font-size:0.8rem; color:#999; padding:5px;'>لا يوجد نتائج</p>"; return; }
        container.innerHTML = history.map(h => `<div class="history-item"><span><b>${h.type}:</b> ${h.score}</span><span style="color:#888;">${h.date}</span></div>`).join('');
    }

    // --- 3. فحص النظر ---
    const vLevels = [110, 80, 60, 40, 25, 15]; 
    const vScores = ["6/60", "6/36", "6/24", "6/12", "6/9", "6/6"];
    let vStep = 0;
    let vRot = 0;

    function startVisionTest() { vStep = 0; showScreen('screen-vision'); nextVStep(); }

    function nextVStep() {
        if(vStep >= vLevels.length) { endTest("نظر", "6/6"); return; }
        document.getElementById('vision-prog').style.width = ((vStep+1)/vLevels.length)*100 + "%";
        const e = document.getElementById('e-char');
        e.style.fontSize = vLevels[vStep] + "px";
        vRot = [0, 90, 180, 270][Math.floor(Math.random()*4)];
        e.style.transform = `rotate(${vRot}deg)`;
    }

    function processVision(ans) {
        if(ans === vRot) { playTone(500); vStep++; nextVStep(); } // نغمة ناعمة
        else { playTone(250); endTest("نظر", vScores[vStep-1] || "ضعيف"); } // نغمة مختلفة للخطأ
    }

    // --- 4. فحص الألوان (صور مضمونة 100%) ---
    // استخدمت روابط لصور تعرض الرقم بوضوح تام، لضمان عمل الفحص حتى لو النت ضعيف
    const colorData = [
        {img: "https://placehold.co/220x220/e0f2f1/00796B?text=12&font=roboto", ans: 12, opts: [12, 8, 3, 0]},
        {img: "https://placehold.co/220x220/fff3e0/e65100?text=74&font=roboto", ans: 74, opts: [71, 74, 21, 14]},
        {img: "https://placehold.co/220x220/fce4ec/880e4f?text=8&font=roboto", ans: 8, opts: [3, 8, 5, 2]},
        {img: "https://placehold.co/220x220/e8eaf6/1a237e?text=6&font=roboto", ans: 6, opts: [6, 5, 2, 9]}
    ];
    let cStep = 0;
    let cCorrect = 0;

    function startColorTest() { cStep = 0; cCorrect = 0; showScreen('screen-color'); nextCStep(); }

    function nextCStep() {
        if(cStep >= colorData.length) { 
            let score = (cCorrect === colorData.length) ? "سليم" : "اشتباه";
            endTest("ألوان", score); 
            return; 
        }
        document.getElementById('color-prog').style.width = ((cStep+1)/colorData.length)*100 + "%";
        const data = colorData[cStep];
        document.getElementById('color-img').src = data.img;
        document.getElementById('color-opts').innerHTML = data.opts.map(o => `<button class="opt-btn" onclick="processColor(${o})">${o}</button>`).join('');
    }

    function processColor(ans) {
        if(ans === colorData[cStep].ans) { cCorrect++; playTone(500); } 
        else { playTone(250); }
        cStep++; nextCStep();
    }

    // --- عام ---
    function endTest(type, score) {
        showScreen('screen-result');
        document.getElementById('result-val').textContent = score;
        document.getElementById('result-title').textContent = "نتيجة فحص ال" + type;
        saveResult(type, score);
        document.getElementById('wa-link').href = `https://wa.me/962775549700?text=نتيجتي في فحص ال${type}: ${score}`;
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function toggleMute() {
        isMuted = !isMuted;
        document.getElementById('muteBtn').innerHTML = isMuted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
    }

    window.onload = loadHistory;
</script>

</body>
</html>
