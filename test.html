<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Delta Optics | النظام المتكامل</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #00796B; --gold: #D4AF37; --bg: #f0f4f4; --text: #37474F; --success: #4CAF50; --error: #F44336; }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; display: flex; flex-direction: column; }
        
        header { background: #fff; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; }
        .logo-text { font-weight: 800; color: var(--primary); font-size: 1.1rem; }
        
        .test-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .screen { display: none; width: 100%; max-width: 450px; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; animation: fadeIn 0.4s; }
        .screen.active { display: block; }

        /* شاشة عمى الألوان */
        .color-test-img { width: 220px; height: 220px; border-radius: 50%; margin-bottom: 20px; border: 5px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .color-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .opt-btn { padding: 15px; border: 1px solid #eee; border-radius: 12px; background: #fafafa; cursor: pointer; font-weight: bold; font-size: 1.1rem; transition: 0.2s; }
        .opt-btn:active { background: var(--primary); color: white; }

        /* سجل النتائج */
        .history-list { text-align: right; margin-top: 20px; max-height: 180px; overflow-y: auto; background: #fafafa; padding: 10px; border-radius: 10px; }
        .history-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-size: 0.85rem; }
        .history-item:last-child { border-bottom: none; }

        .btn-main { background: var(--primary); color: white; padding: 15px 30px; border-radius: 50px; border: none; font-weight: 800; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.3s; font-size: 1rem; }
        .btn-secondary { background: #fff; color: var(--text); border: 1px solid #ddd; padding: 12px; border-radius: 50px; width: 100%; margin-top: 10px; font-weight: bold; cursor: pointer; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* شريط التقدم */
        .prog-container { width: 100%; height: 8px; background: #eee; border-radius: 10px; margin-bottom: 20px; overflow: hidden; }
        .prog-bar { height: 100%; background: var(--primary); width: 0%; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .e-box { font-size: 100px; font-weight: 900; margin: 30px 0; transition: transform 0.3s; display: inline-block; line-height: 1; }
        
        /* أزرار التحكم */
        .ctrl-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 250px; margin: 0 auto; }
        .ctrl-btn { width: 60px; height: 60px; background: #fff; border: 1px solid #eee; border-radius: 15px; font-size: 1.5rem; color: var(--primary); cursor: pointer; box-shadow: 0 4px 0 #eee; }
        .ctrl-btn:active { transform: translateY(4px); box-shadow: none; }
    </style>
</head>
<body>

<header>
    <a href="index.html" style="text-decoration:none; color:inherit; font-size: 1.2rem;"><i class="fas fa-times"></i></a>
    <span class="logo-text">مركز الفحص الذكي</span>
    <div id="muteBtn" onclick="toggleMute()" style="cursor:pointer; color:var(--primary); font-size: 1.2rem;"><i class="fas fa-volume-up"></i></div>
</header>

<div class="test-container">

    <div id="screen-start" class="screen active">
        <i class="fas fa-eye-low-vision" style="font-size: 3.5rem; color: var(--primary); margin-bottom: 15px;"></i>
        <h2>اختر نوع الفحص</h2>
        <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">نقدم لك تجربة فحص دقيقة وسريعة</p>
        
        <button class="btn-main" onclick="startVisionTest()">
            <i class="fas fa-eye"></i> فحص حدة النظر
        </button>
        <button class="btn-secondary" onclick="startColorTest()">
            <i class="fas fa-palette"></i> فحص عمى الألوان
        </button>
        
        <div class="history-list" id="history-container">
            <div style="font-weight:bold; font-size:0.8rem; margin-bottom:5px; color:var(--gold);">سجل نتائجك السابقة:</div>
            <div id="history-items"></div>
        </div>
    </div>

    <div id="screen-vision" class="screen">
        <div class="prog-container"><div id="vision-prog" class="prog-bar"></div></div>
        <div id="e-char" class="e-box">E</div>
        <p style="color:#999; font-size:0.9rem;">حدد اتجاه الفتحة</p>
        <div class="ctrl-grid">
            <button class="ctrl-btn" style="grid-column: 2" onclick="processVision(270)"><i class="fas fa-arrow-up"></i></button>
            <button class="ctrl-btn" style="grid-column: 1; grid-row: 2" onclick="processVision(180)"><i class="fas fa-arrow-left"></i></button>
            <button class="ctrl-btn" style="grid-column: 2; grid-row: 2" onclick="processVision(90)"><i class="fas fa-arrow-down"></i></button>
            <button class="ctrl-btn" style="grid-column: 3; grid-row: 2" onclick="processVision(0)"><i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <div id="screen-color" class="screen">
        <h3 style="margin-bottom:20px;">ما هو الرقم في الصورة؟</h3>
        <img id="color-img" src="" class="color-test-img" alt="اختبار الألوان">
        <div class="color-options" id="color-opts"></div>
    </div>

    <div id="screen-result" class="screen">
        <div style="width:100px; height:100px; background:var(--bg); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 15px; font-size:2.5rem; color:var(--primary);">
            <i class="fas fa-check"></i>
        </div>
        <h3 id="result-title">النتيجة</h3>
        <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary); margin: 10px 0;" id="result-val">---</div>
        <p id="result-desc" style="color:#666; font-size:0.9rem;">يرجى مراجعة المركز للحصول على تقرير طبي معتمد.</p>
        
        <a id="wa-link" href="#" class="btn-main" style="display:block; text-decoration:none; background:#25D366; color:white;">
            <i class="fab fa-whatsapp"></i> حجز موعد بالنتيجة
        </a>
        <button class="btn-secondary" onclick="location.reload()">العودة للرئيسية</button>
    </div>

</div>

<script>
    // --- 1. نظام الصوت الناعم (Soft Sound) ---
    let isMuted = false;
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playTone(freq, type = 'sine') {
        if (isMuted) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.type = type; 
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

        // جعل الصوت ناعم جداً (Fade In/Out)
        gain.gain.setValueAtTime(0, audioCtx.currentTime);
        gain.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime + 0.05); // صوت هادئ
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);

        osc.connect(gain);
        gain.connect(audioCtx.destination);

        osc.start();
        osc.stop(audioCtx.currentTime + 0.3);
    }

    // --- 2. نظام السجل (LocalStorage) ---
    function saveResult(type, score) {
        let history = JSON.parse(localStorage.getItem('delta_history') || '[]');
        const entry = {
            type: type,
            score: score,
            date: new Date().toLocaleDateString('ar-EG', {day:'numeric', month:'short'})
        };
        history.unshift(entry);
        localStorage.setItem('delta_history', JSON.stringify(history.slice(0, 5))); // حفظ آخر 5 فقط
        loadHistory();
    }

    function loadHistory() {
        const container = document.getElementById('history-items');
        let history = JSON.parse(localStorage.getItem('delta_history') || '[]');
        
        if(history.length === 0) { 
            container.innerHTML = "<p style='font-size:0.8rem; color:#999; padding:10px;'>لا يوجد سجل فحوصات سابق</p>"; 
            return; 
        }
        
        container.innerHTML = history.map(h => `
            <div class="history-item">
                <span style="color:var(--text)"><b>${h.type}:</b> ${h.score}</span>
                <span style="color:#888;">${h.date}</span>
            </div>
        `).join('');
    }

    // --- 3. فحص النظر (E) ---
    const vLevels = [110, 80, 60, 40, 20, 10]; // أحجام أصغر تدريجياً
    const vScores = ["6/60", "6/36", "6/24", "6/12", "6/9", "6/6"];
    let vStep = 0;
    let vRot = 0;

    function startVisionTest() {
        vStep = 0; 
        showScreen('screen-vision'); 
        nextVStep();
    }

    function nextVStep() {
        if(vStep >= vLevels.length) { endTest("نظر", "6/6"); return; }
        
        // تحديث شريط التقدم
        document.getElementById('vision-prog').style.width = ((vStep+1)/vLevels.length)*100 + "%";
        
        const e = document.getElementById('e-char');
        e.style.fontSize = vLevels[vStep] + "px";
        
        // تدوير عشوائي
        vRot = [0, 90, 180, 270][Math.floor(Math.random()*4)];
        e.style.transform = `rotate(${vRot}deg)`;
    }

    function processVision(ans) {
        if(ans === vRot) { 
            playTone(523.25); // نغمة "Do" ناعمة
            vStep++; 
            nextVStep(); 
        } else { 
            playTone(196.00, 'triangle'); // نغمة "So" منخفضة للخطأ
            endTest("نظر", vScores[vStep-1] || "ضعيف"); 
        }
    }

    // --- 4. فحص عمى الألوان ---
    // صور حقيقية لاختبار إيشيهارا
    const colorData = [
        {img: "https://upload.wikimedia.org/wikipedia/commons/e/e0/Ishihara_1.png", ans: 12, opts: [12, 8, 3, 0]},
        {img: "https://upload.wikimedia.org/wikipedia/commons/b/b1/Ishihara_9.png", ans: 74, opts: [71, 74, 21, 14]},
        {img: "https://upload.wikimedia.org/wikipedia/commons/b/be/Ishihara_2.png", ans: 8, opts: [3, 8, 5, 2]}
    ];
    let cStep = 0;
    let cCorrect = 0;

    function startColorTest() {
        cStep = 0; cCorrect = 0; 
        showScreen('screen-color'); 
        nextCStep();
    }

    function nextCStep() {
        if(cStep >= colorData.length) { 
            // تقييم النتيجة
            let score = (cCorrect === colorData.length) ? "ممتاز" : "يوجد اشتباه";
            endTest("ألوان", score); 
            return; 
        }
        
        const data = colorData[cStep];
        document.getElementById('color-img').src = data.img;
        
        // توليد الأزرار
        const optsBox = document.getElementById('color-opts');
        optsBox.innerHTML = data.opts.map(o => 
            `<button class="opt-btn" onclick="processColor(${o})">${o}</button>`
        ).join('');
    }

    function processColor(ans) {
        if(ans === colorData[cStep].ans) { 
            cCorrect++; 
            playTone(523.25); 
        } else { 
            playTone(196.00, 'triangle'); 
        }
        cStep++; 
        nextCStep();
    }

    // --- دوال مساعدة ---
    function endTest(type, score) {
        showScreen('screen-result');
        document.getElementById('result-val').textContent = score;
        document.getElementById('result-title').textContent = "نتيجة فحص ال" + type;
        
        saveResult(type, score);
        
        // تجهيز رابط الواتساب
        const msg = encodeURIComponent(`مرحباً دلتا للبصريات، قمت بفحص ال${type} وكانت النتيجة: ${score}، أرغب بحجز موعد للفحص الطبي.`);
        document.getElementById('wa-link').href = `https://wa.me/962775549700?text=${msg}`;
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function toggleMute() {
        isMuted = !isMuted;
        const icon = isMuted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
        document.getElementById('muteBtn').innerHTML = icon;
    }

    // تحميل السجل عند فتح الصفحة
    window.onload = loadHistory;
</script>

</body>
</html>
