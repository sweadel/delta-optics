<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Delta Optics | التشكيلة الذكية</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #00796B; --gold: #D4AF37; --bg: #FAFAFA; --text: #37474F; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 60px; }
        
        header { background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: fixed; width: 100%; top: 0; z-index: 1000; height: 60px; display: flex; align-items: center; padding: 0 15px; }
        .nav-container { width: 100%; max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex: 1; }
        .back-btn { font-size: 1.2rem; color: var(--primary); font-weight: bold; }
        .logo-text { font-size: 1.2rem; font-weight: 800; color: var(--primary); }

        /* --- قسم الكاميرا والذكاء الاصطناعي --- */
        .ai-camera-section {
            background: #fff; margin: 80px 15px 20px; padding: 20px; border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,121,107,0.1); text-align: center; border: 1px solid #E0F2F1;
        }
        .ai-title { color: var(--primary); font-weight: 800; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        #camera-container {
            width: 100%; max-width: 400px; margin: 10px auto; border-radius: 15px; overflow: hidden;
            background: #000; position: relative; display: none; /* مخفي في البداية */
        }
        video, canvas { width: 100%; height: auto; display: block; transform: scaleX(-1); } /* عكس الصورة كالمراية */
        
        .action-btn {
            background: var(--primary); color: white; border: none; padding: 12px 25px;
            border-radius: 50px; font-weight: bold; cursor: pointer; margin: 10px 5px;
            display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(0,121,107,0.2); transition: 0.2s;
        }
        .action-btn:active { transform: scale(0.95); }
        .btn-capture { background: var(--gold); color: #333; }
        
        #ai-result { 
            margin-top: 15px; padding: 15px; background: #E0F2F1; border-radius: 10px; 
            font-size: 0.95rem; color: #004D40; line-height: 1.6; display: none; 
        }

        /* --- الشبكة والصور --- */
        .gallery-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 15px 30px; max-width: 1200px; margin: 0 auto; }
        .product-card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.04); border: 1px solid #f0f0f0; }
        .img-box { height: 160px; background: #f9f9f9; display: flex; align-items: center; justify-content: center; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: 0.5s; }
        .img-box img.loaded { opacity: 1; }
        .info { padding: 10px; text-align: center; }
        .wa-btn { display: block; background: #25D366; color: white; padding: 8px; border-radius: 6px; font-weight: bold; text-decoration: none; font-size: 0.8rem; margin-top: 5px; }
    </style>
</head>
<body>

    <header>
        <div class="nav-container">
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-right"></i> رجوع</a>
            <span class="logo-text">التشكيلة الذكية</span>
            <div style="width:20px"></div>
        </div>
    </header>

    <div class="ai-camera-section">
        <h3 class="ai-title"><i class="fas fa-robot"></i> مستشار النظارات الذكي</h3>
        <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">صور نفسك ودع الذكاء الاصطناعي يختار لك النظارة الأنسب لشكل وجهك!</p>
        
        <div id="controls">
            <button class="action-btn" onclick="startCamera()"><i class="fas fa-camera"></i> تشغيل الكاميرا</button>
            <input type="file" id="file-upload" accept="image/*" style="display:none" onchange="handleFileUpload(event)">
            <button class="action-btn" style="background:#fff; color:var(--primary); border:1px solid var(--primary);" onclick="document.getElementById('file-upload').click()">
                <i class="fas fa-upload"></i> أو ارفع صورة
            </button>
        </div>

        <div id="camera-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <div style="position:absolute; bottom:15px; left:0; right:0; text-align:center;">
                <button class="action-btn btn-capture" onclick="captureAndAnalyze()">
                    <i class="fas fa-camera-retro"></i> التقاط وتحليل
                </button>
            </div>
        </div>

        <div id="ai-result">
            <strong id="loading-text"><i class="fas fa-spinner fa-spin"></i> جاري تحليل الوجه...</strong>
            <p id="advice-text"></p>
        </div>
    </div>

    <div class="gallery-grid" id="container"></div>

    <script>
        // ********** هام جداً: ضع مفتاح API الخاص بك هنا **********
        const API_KEY = "ضع_مفتاح_API_الخاص_بك_هنا"; 
        // مثال: const API_KEY = "AIzaSyD......";

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const cameraContainer = document.getElementById('camera-container');
        const resultBox = document.getElementById('ai-result');
        const loadingText = document.getElementById('loading-text');
        const adviceText = document.getElementById('advice-text');

        // 1. تشغيل الكاميرا
        async function startCamera() {
            cameraContainer.style.display = 'block';
            resultBox.style.display = 'none';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" } // استخدام الكاميرا الأمامية
                });
                video.srcObject = stream;
            } catch (err) {
                alert("عذراً، لا يمكن الوصول للكاميرا. تأكد من إعطاء الصلاحيات.");
                console.error(err);
            }
        }

        // 2. التقاط الصورة وإرسالها للتحليل
        function captureAndAnalyze() {
            // رسم الصورة الحالية من الفيديو على الكانفاس
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            // إيقاف الكاميرا وتجميد الصورة
            video.pause();
            
            // تحويل الصورة لنص (Base64) لإرسالها للذكاء الاصطناعي
            const imageData = canvas.toDataURL('image/jpeg').split(',')[1];
            
            analyzeWithGemini(imageData);
        }

        // 3. رفع صورة من الجهاز (خيار بديل)
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function() {
                const base64 = reader.result.split(',')[1];
                analyzeWithGemini(base64);
            };
            reader.readAsDataURL(file);
        }

        // 4. إرسال الصورة لـ Gemini API
        async function analyzeWithGemini(base64Image) {
            resultBox.style.display = 'block';
            loadingText.style.display = 'block';
            adviceText.innerHTML = '';
            cameraContainer.style.display = 'none'; // إخفاء الكاميرا أثناء التحليل

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "أنت خبير بصريات. حلل شكل الوجه في الصورة (دائري، بيضاوي، مربع، قلب) واقترح بالعامية الأردنية اللطيفة أفضل 3 أشكال نظارات تناسب هذا الوجه. كن مختصراً." },
                                { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                
                // إعادة تشغيل الكاميرا لاستخدام آخر
                if(video.srcObject) { 
                    const tracks = video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                }

                if (data.candidates && data.candidates[0].content) {
                    loadingText.style.display = 'none';
                    adviceText.innerHTML = data.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
                } else {
                    throw new Error("No response");
                }

            } catch (error) {
                console.error(error);
                loadingText.innerText = "حدث خطأ بسيط، حاول مرة أخرى!";
            }
        }

        // --- كود عرض المنتجات (نفس السابق) ---
        const LIMIT = 20;
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('container');
            let html = '';
            for (let i = 1; i <= LIMIT; i++) { html += createCard('medical', i, `m${i}.jpg.jpg`); }
            for (let i = 1; i <= LIMIT; i++) { html += createCard('sun', i, `s${i}.jpg.jpg`); }
            container.innerHTML = html;
        });

        function createCard(type, index, fileName) {
            return `<div class="product-card">
                <div class="img-box"><img src="${fileName}" onload="this.classList.add('loaded')" onerror="this.closest('.product-card').remove()"></div>
                <div class="info">
                    <h4 style="font-size:0.8rem;">${type==='medical'?'طبي':'شمسي'} #${index}</h4>
                    <a href="https://wa.me/962775549700?text=صورة الموديل: ${fileName}" class="wa-btn"><i class="fab fa-whatsapp"></i> طلب واتساب</a>
                </div>
            </div>`;
        }
    </script>
</body>
</html>
